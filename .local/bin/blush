#!/bin/sh
case $- in *i*) ;; *) exit 2;; esac
cd "${1:-missing path}" || return
VERYOLDPWD=$OLDPWD

_se_name=${2:-${PWD##*/}}

_ex_alias() (
  n=`alias "$1" 2>/dev/null` || echo "$1"
  eval echo "${n##*=}"
)

quit() {
  daety -i "$_se_name:tre" -c ':q^M' '' --
  daety -i "$_se_name:vim" -c ':^Uqa!^M' '' --
  unset -f cd
  unset -f quit
  unset -f _ex_alias
  cd $VERYOLDPWD
  unset _se_name
  unset VERYOLDPWD
}

cd() {
  daety -i "$_se_name:tre" -c ":cd '$1'^M" '' --
  daety -i "$_se_name:vim" -c ":^Ucd $1^M" '' --
  command cd "$1"
}

daety -i "$_se_name:tre" -- `_ex_alias tre` &
daety -i "$_se_name:vim" -- `_ex_alias vim` &
